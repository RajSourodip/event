<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>District Records</title>
    <style>
      .district-button {
        padding: 10px;
        margin: 5px;
        background-color: #4caf50;
        color: white;
        border: none;
        cursor: pointer;
      }
      .district-button:hover {
        background-color: #45a049;
      }
      .record {
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <h1>User's District Reports</h1>

    <!-- Buttons for Districts will be injected here -->
    <div id="district-buttons"></div>

    <!-- Records for the selected district -->
    <div id="records-container"></div>

    <script>
      // Fetch all the reports for the user and classify them by districts
      document.addEventListener("DOMContentLoaded", async function () {
        try {
          const userDistricts = await fetchReportsByUser();

          if (userDistricts) {
            // Dynamically create buttons for each district
            const districtButtonsDiv =
              document.getElementById("district-buttons");
            Object.keys(userDistricts).forEach((district) => {
              const button = document.createElement("button");
              button.classList.add("district-button");
              button.textContent = district;
              button.onclick = () =>
                displayDistrictRecords(district, userDistricts[district]);
              districtButtonsDiv.appendChild(button);
            });
          }
        } catch (error) {
          console.error("Error fetching user reports:", error);
        }
      });

      // Function to fetch reports based on the authenticated user
      async function fetchReportsByUser() {
        const response = await fetch("/getReportsByDistrict");
        const data = await response.json();

        if (data.status === "success") {
          // Classify reports by district
          const reportsByDistrict = {};

          data.data.forEach((report) => {
            const district = report.district;
            if (!reportsByDistrict[district]) {
              reportsByDistrict[district] = [];
            }
            reportsByDistrict[district].push(report);
          });

          return reportsByDistrict;
        } else {
          alert("Failed to fetch reports");
          return null;
        }
      }

      // Function to display records for the selected district
      function displayDistrictRecords(district, records) {
        const recordsContainer = document.getElementById("records-container");
        recordsContainer.innerHTML = ""; // Clear previous records

        const districtTitle = document.createElement("h2");
        districtTitle.textContent = `Records for ${district}`;
        recordsContainer.appendChild(districtTitle);

        records.forEach((report) => {
          const reportDiv = document.createElement("div");
          reportDiv.classList.add("record");
          reportDiv.innerHTML = `
                    <p><strong>Date:</strong> ${report.date}</p>
                    <p><strong>Total Schools Visited:</strong> ${report.totalSchoolsVisited}</p>
                    <p><strong>Interested:</strong> ${report.interested}</p>
                    <p><strong>Follow Up Signed:</strong> ${report.signed}</p>
                    <!-- Add more fields as needed -->
                `;
          recordsContainer.appendChild(reportDiv);
        });
      }
    </script>
  </body>
</html>
